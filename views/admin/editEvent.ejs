<!DOCTYPE html>
<html lang="en">
  <head>
    <%- include('../partials/header.ejs') %>
  </head>
  <body>
    <div class="main">
      <%- include('../partials/navbar.ejs') %>

      <div class="add-edit-container">
        <h1 class="headingg margin">Edit Event</h1>

        <form
          class="add-edit-form"
          action="/admin/edit-event/<%= locals.event._id %>"
          method="post"
        >
          <label>
            <p>ğŸ“ Event Title</p>
            <input
              type="text"
              name="title"
              value="<%= locals.event.title %>"
              minlength="20"
              required
            />
          </label>

          <label>
            <p>ğŸ“„ Short Description</p>
            <textarea name="shortDescription" minlength="100" required>
<%= locals.event.shortDescription %></textarea
            >
          </label>

          <label>
            <p>ğŸ“‹ Session Overview</p>
            <textarea name="description" minlength="100" required>
<%= locals.event.description %></textarea
            >
          </label>

          <label>
            <p>ğŸ¢ Organiser's Name</p>
            <input
              type="text"
              name="organiser"
              value="<%= locals.event.organiser %>"
              required
            />
          </label>

          <label>
            <p>ğŸ“ Venue</p>
            <input
              type="text"
              name="venue"
              value="<%= locals.event.venue %>"
              required
            />
          </label>

          <label>
            <p>ğŸ‘¥ Venue Capacity</p>
            <input
              type="number"
              name="capacity"
              value="<%= locals.event.capacity %>"
              min="1"
              max="100000"
              required
            />
          </label>

          <label>
            <p>ğŸ• Start Date and Time</p>
            <input type="datetime-local" id="startUI" required />
            <input
              type="hidden"
              name="startTime"
              id="startHidden"
              value="<%= locals.event.startTime ? new Date(locals.event.startTime).toISOString() : '' %>"
            />
          </label>

          <div class="crack">
            <label class="buzz">â° Registration Deadline</label>
            <div class="checkk">
              <input type="checkbox" id="deadlineCheck" />
              <label for="deadlineCheck">Same as start date and time</label>
            </div>
            <input type="datetime-local" id="deadlineUI" required />
            <input
              type="hidden"
              name="deadline"
              id="deadlineHidden"
              value="<%= locals.event.deadline ? new Date(locals.event.deadline).toISOString() : '' %>"
            />
            <p class="link add-edit-size">
              Last date and time for registration
            </p>
          </div>

          <label>
            <p>ğŸ•‘ End Date and Time</p>
            <input type="datetime-local" id="endUI" required />
            <input
              type="hidden"
              name="endTime"
              id="endHidden"
              value="<%= locals.event.endTime ? new Date(locals.event.endTime).toISOString() : '' %>"
            />
          </label>

          <div class="crack">
            <label class="buzz">ğŸ“‹ Publisher's Name</label>
            <div class="checkk">
              <input type="checkbox" id="authorCheck" />
              <label for="authorCheck">Same as admin's name</label>
            </div>
            <input
              type="text"
              name="author"
              id="author"
              value="<%= locals.event.author ?? 'Dr Lipika Das' %>"
              data-author="<%= locals.user.fullName %>"
              data-original-author="<%= locals.event.author %>"
              maxlength="32"
              required
            />
          </div>

          <label>
            <p>ğŸ“‹ Publisher's Position</p>
            <input
              type="text"
              name="position"
              value="<%= locals.event.position ?? 'Chair, HRDC' %>"
              maxlength="32"
              required
            />
          </label>

          <button class="add-edit-button" type="submit">âœ¨ Make Changes</button>
        </form>
      </div>
    </div>

    <%- include('../partials/footer.ejs') %>

    <script>
      // 1. Select all elements
      const startUI = document.getElementById("startUI");
      const startHidden = document.getElementById("startHidden");
      const deadlineUI = document.getElementById("deadlineUI");
      const deadlineHidden = document.getElementById("deadlineHidden");
      const endUI = document.getElementById("endUI");
      const endHidden = document.getElementById("endHidden");

      // 2. HELPER: UTC ISO -> Local YYYY-MM-DDTHH:mm
      const setLocalTime = (uiElement, utcValue) => {
        if (!uiElement || !utcValue) return;
        const date = new Date(utcValue);
        if (isNaN(date.getTime())) return;
        const offset = date.getTimezoneOffset();
        const localDate = new Date(date.getTime() - offset * 60000);
        uiElement.value = localDate.toISOString().slice(0, 16);
      };

      // 3. HELPER: Local UI -> UTC ISO
      const updateHidden = (uiElement, hiddenElement) => {
        if (!uiElement.value) {
          hiddenElement.value = "";
          return;
        }
        const date = new Date(uiElement.value);
        hiddenElement.value = date.toISOString(); // Adds the 'Z'
      };

      // 4. INITIALIZE: Convert DB UTC values to Local UI values on load
      setLocalTime(startUI, startHidden.value);
      setLocalTime(deadlineUI, deadlineHidden.value);
      setLocalTime(endUI, endHidden.value);

      // Store original deadline for the "uncheck" revert logic
      deadlineUI.dataset.original = deadlineUI.value;

      // 5. LISTENERS: Update Hidden fields whenever UI changes
      startUI.addEventListener("input", () =>
        updateHidden(startUI, startHidden)
      );
      deadlineUI.addEventListener("input", () =>
        updateHidden(deadlineUI, deadlineHidden)
      );
      endUI.addEventListener("input", () => updateHidden(endUI, endHidden));

      // 6. CHECKBOX LOGIC (Deadline)
      const deadlineCheck = document.getElementById("deadlineCheck");
      function syncDeadline() {
        deadlineUI.value = startUI.value;
        deadlineHidden.value = startHidden.value;
      }

      if (deadlineCheck) {
        deadlineCheck.addEventListener("change", (e) => {
          if (e.target.checked) {
            deadlineUI.readOnly = true;
            syncDeadline();
            startUI.addEventListener("input", syncDeadline);
            deadlineUI.style.backgroundColor = "#eee";
            deadlineUI.style.color = "#666";
          } else {
            deadlineUI.readOnly = false;
            startUI.removeEventListener("input", syncDeadline);
            if (deadlineUI.dataset.original) {
              deadlineUI.value = deadlineUI.dataset.original;
              updateHidden(deadlineUI, deadlineHidden);
            }
            deadlineUI.style.backgroundColor = "unset";
            deadlineUI.style.color = "unset";
          }
        });
      }

      // 7. AUTHOR LOGIC
      const author = document.getElementById("author");
      const authorCheck = document.getElementById("authorCheck");
      if (authorCheck && author) {
        const authorName = author.dataset.author || "";
        const finalName = authorName
          .split(" ")
          .map((w) => w[0].toUpperCase() + w.slice(1))
          .join(" ");
        const originalName = author.dataset.originalAuthor;

        authorCheck.addEventListener("change", (e) => {
          if (e.target.checked) {
            author.readOnly = true;
            author.value = finalName;
            author.style.backgroundColor = "#eee";
            author.style.color = "#666";
          } else {
            author.readOnly = false;
            author.value = originalName;
            author.style.backgroundColor = "unset";
            author.style.color = "unset";
          }
        });
      }
    </script>
  </body>
</html>
