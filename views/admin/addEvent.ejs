<!DOCTYPE html>
<html lang="en">
  <head>
    <%- include('../partials/header.ejs') %>
  </head>
  <body>
    <div class="main">
      <%- include('../partials/navbar.ejs') %>
      <div class="add-edit-container">
        <h1 class="headingg margin">Add Event</h1>

        <form class="add-edit-form" action="/admin/create-event" method="post">
          <label>
            <p>ğŸ“ Event Title</p>
            <input
              type="text"
              name="title"
              placeholder="Enter event title"
              minlength="20"
              id="title"
              required
            />
          </label>
          <label>
            <p>ğŸ“„ Short Description</p>
            <textarea
              type="text"
              name="shortDescription"
              placeholder="Enter a brief description"
              id="shortDescription"
              minlength="100"
              required
            ></textarea>
          </label>
          <label>
            <p>ğŸ“‹ Session Overview</p>
            <textarea
              type="text"
              name="description"
              placeholder="Enter detailed session overview"
              id="description"
              minlength="100"
              required
            ></textarea>
          </label>
          <label>
            <p>ğŸ¢ Organiser's Name</p>
            <input
              type="text"
              placeholder="Enter organization name (e.g., IEEE, HRDC)"
              name="organiser"
              id="organiser"
              required
            />
          </label>
          <label>
            <p>ğŸ“ Venue</p>
            <input
              placeholder="Enter venue location"
              type="text"
              name="venue"
              id="venue"
              required
            />
          </label>
          <label>
            <p>ğŸ‘¥ Venue Capacity</p>
            <input
              type="number"
              name="capacity"
              id="capacity"
              placeholder="Enter venue capacity"
              min="1"
              max="100000"
              required
            />
          </label>

          <label>
            <p>ğŸ• Start Date and Time</p>
            <input type="datetime-local" id="startUI" required />
            <input type="hidden" name="startTime" id="startHidden" />
          </label>

          <div class="crack">
            <label class="buzz" for="deadline">â° Registration Deadline</label>

            <div class="checkk">
              <input type="checkbox" id="deadlineCheck" name="deadlineCheck" />
              <label for="deadlineCheck">Same as start date and time</label>
            </div>

            <input type="datetime-local" id="deadlineUI" required />
            <input type="hidden" name="deadline" id="deadlineHidden" />

            <p class="link add-edit-size">
              Last date and time for registration
            </p>
          </div>

          <label>
            <p>ğŸ•‘ End Date and Time</p>
            <input type="datetime-local" id="endUI" required />
            <input type="hidden" name="endTime" id="endHidden" />
          </label>

          <div class="crack">
            <label for="author" class="buzz">ğŸ“‹ Publisher's Name</label>

            <div class="checkk">
              <input type="checkbox" id="authorCheck" name="authorCheck" />
              <label for="authorCheck">Same as admin's name</label>
            </div>
            <input
              type="text"
              name="author"
              id="author"
              data-author="<%= locals.user.fullName %>"
              placeholder="Enter publisher's name"
              maxlength="32"
              required
            />
          </div>
          <label>
            <p>ğŸ“‹ Publisher's Position</p>
            <input
              type="text"
              name="position"
              id="position"
              placeholder="Enter publisher's job position"
              maxlength="32"
              required
            />
          </label>
          <button class="add-edit-button" type="submit">âœ¨ Create Event</button>
        </form>
      </div>
    </div>
    <%- include('../partials/footer.ejs') %>

    <script>
      console.log("ğŸš€ Create Event Script Loaded");

      // --- 1. CONFIGURATION ---
      // Map visible inputs to hidden inputs
      const fields = [
        { uiId: "startUI", hiddenId: "startHidden" },
        { uiId: "deadlineUI", hiddenId: "deadlineHidden" },
        { uiId: "endUI", hiddenId: "endHidden" },
      ];

      // --- 2. TIME CONVERSION LOGIC ---

      const localStringToUtc = (localString) => {
        if (!localString) return "";
        const date = new Date(localString);
        if (isNaN(date.getTime())) return "";
        // Convert to UTC ISO String (e.g., 2023-10-27T05:30:00.000Z)
        return date.toISOString();
      };

      // --- 3. EVENT LISTENERS ---

      fields.forEach((field) => {
        const ui = document.getElementById(field.uiId);
        const hidden = document.getElementById(field.hiddenId);

        if (ui && hidden) {
          ui.addEventListener("input", (e) => {
            // When user types, update the hidden field immediately
            hidden.value = localStringToUtc(e.target.value);
          });
        }
      });

      // --- 4. CHECKBOX LOGIC (Updated) ---

      const deadlineCheck = document.getElementById("deadlineCheck");
      const startUI = document.getElementById("startUI");
      const startHidden = document.getElementById("startHidden");
      const deadlineUI = document.getElementById("deadlineUI");
      const deadlineHidden = document.getElementById("deadlineHidden");

      const syncDeadline = () => {
        // Sync Visual
        deadlineUI.value = startUI.value;
        // Sync Hidden Data (Critical!)
        deadlineHidden.value = startHidden.value;
      };

      if (deadlineCheck) {
        deadlineCheck.addEventListener("change", (e) => {
          if (e.target.checked) {
            deadlineUI.readOnly = true;
            syncDeadline(); // Sync immediately
            startUI.addEventListener("input", syncDeadline); // Keep syncing
          } else {
            deadlineUI.readOnly = false;
            startUI.removeEventListener("input", syncDeadline);
            deadlineUI.value = "";
            deadlineHidden.value = ""; // Clear hidden value too
          }
        });
      }

      // --- 5. AUTHOR LOGIC (Unchanged) ---

      const author = document.getElementById("author");
      const authorCheck = document.getElementById("authorCheck");
      const authorName = author.dataset.author || "";

      const finalName = authorName
        .split(" ")
        .reduce(
          (acc, w) => acc + " " + w.slice(0, 1).toUpperCase() + w.slice(1),
          ""
        )
        .trim();

      if (authorCheck) {
        authorCheck.addEventListener("change", (e) => {
          if (e.target.checked) {
            author.readOnly = true;
            author.value = finalName;
          } else {
            author.readOnly = false;
            author.value = "";
          }
        });
      }
    </script>
  </body>
</html>
