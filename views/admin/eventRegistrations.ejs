<!DOCTYPE html>
<html lang="en">
  <head>
    <%- include('../partials/header.ejs') %>
  </head>
  <body>
    <div class="main">
      <%- include('../partials/navbar.ejs') %>

      <!-- üîí RAW UTC DATA (SERVER ONLY OUTPUTS DATA) -->
      <div
        id="eventTimeData"
        data-start="<%= locals.eventDetails.startTime.toISOString() %>"
        data-end="<%= locals.eventDetails.endTime.toISOString() %>"
        data-deadline="<%= locals.eventDetails.deadline.toISOString() %>"
      ></div>

      <div class="heading-div">
        <h1 class="heading">Attendance Management</h1>
        <div id="eventStatus" class="status-live"></div>
      </div>

      <div class="event-det-container container-border">
        <h1 class="event-det-heading">
          <div
            id="liveBadge"
            class="event-det-live"
            style="display: none"
          >
            üî¥Live
          </div>
          <span class="headd"><%= locals.eventDetails.title %></span>
        </h1>

        <p class="event-det-deadline">
          <img
            src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMCIgaGVpZ2h0PSIyMCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IiNmZGZkZmQiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIiBjbGFzcz0ibHVjaWRlIGx1Y2lkZS1hbGFybS1jbG9jayI+PGNpcmNsZSBjeD0iMTIiIGN5PSIxMyIgcj0iOCIvPjxwYXRoIGQ9Ik0xMiA5djRsMiAyIi8+PC9zdmc+"
          />
          <span id="deadlineText"></span>
        </p>

        <div class="event-det-body">
          <p class="event-det-dates prim">
            <span class="event-det-start-date">
              üóìÔ∏è <span id="startText"></span>
            </span>
            <span>-></span>
            <span class="event-det-end-date">
              üóìÔ∏è <span id="endText"></span>
            </span>
          </p>
        </div>
      </div>

      <!-- LIVE SCANNER -->
      <div
        id="scanner"
        class="attendance-scanner-div"
        style="display: none"
      >
        <div class="attendance-scanner-heading">
          üìã Quick Attendance Scanner
        </div>
        <div class="attendance-scanner-sub-heading">
          Enter student's registration code to mark attendance instantly
        </div>
        <form
          method="post"
          action="/admin/mark-attendance/<%= locals.eventDetails._id %>"
          class="attendance-scanner-code-div"
        >
          <input
            required
            name="code"
            type="text"
            id="codeInput"
            placeholder="XXX-XXX-XXX"
            maxlength="11"
            class="attendance-scanner-code"
          />
          <button class="attendance-scanner-code-button">
            Mark Attendance
          </button>
        </form>
      </div>

      <div class="attendance-status-div">
        <div class="attendance-registered-div">
          <div class="attendance-registered-heading">TOTAL REGISTERED</div>
          <div class="attendance-registered">
            <%= locals.eventRegistrations.length %>
          </div>
        </div>

        <div class="attendance-attended-div">
          <div class="attendance-attended-heading">TOTAL ATTENDED</div>
          <div class="attendance-attended">
            <%= locals.eventRegistrations.filter(r => r.attendanceStatus === 'ATTENDED').length %>
          </div>
        </div>
      </div>

      <% if (locals.eventRegistrations.length) { %>
      <div class="attendance-registered-students-list-div">
        <div class="attendance-registered-students-header">
          <div class="attendance-header-name">STUDENT</div>
          <div class="attendance-header-code big">REGISTRATION CODE</div>
          <div class="attendance-header-status">ATTENDANCE</div>
        </div>

        <% locals.eventRegistrations.forEach(reg => { %>
        <div class="attendance-registered-students-tile">
          <div class="attendance-tile-name-email-div">
            <div class="attendance-tile-name">
              <%= reg.userId.fullName %>
            </div>
            <div class="attendance-tile-email">
              <%= reg.userId.email %>
            </div>
          </div>
          <div class="attendance-tile-code">
            <%= reg.registrationCode.match(/.{1,3}/g).join('-') %>
          </div>
          <div class="attendance-tile-status" data-status="<%= reg.attendanceStatus %>">
          </div>
        </div>
        <% }) %>
      </div>
      <% } %>
    </div>

    <%- include('../partials/footer.ejs') %>

    <!-- ‚úÖ CLIENT-SIDE TIME LOGIC (REAL FIX) -->
    <script>
      const data = document.getElementById("eventTimeData").dataset;

      const start = new Date(data.start);
      const end = new Date(data.end);
      const deadline = new Date(data.deadline);
      const now = new Date(); // USER LOCAL TIME

      const isPre = now < start;
      const isLive = now >= start && now < end;
      const isPost = now >= end;

      const fmt = d =>
        d.toLocaleString(undefined, {
          hour: "numeric",
          minute: "2-digit",
          hour12: true,
          day: "2-digit",
          month: "short",
          year: "numeric",
        });

      document.getElementById("startText").textContent = fmt(start);
      document.getElementById("endText").textContent = fmt(end);
      document.getElementById("deadlineText").textContent =
        "deadline : " + fmt(deadline);

      const status = document.getElementById("eventStatus");
      const liveBadge = document.getElementById("liveBadge");
      const scanner = document.getElementById("scanner");

      if (isLive) {
        status.textContent = "LIVE üî¥";
        liveBadge.style.display = "flex";
        scanner.style.display = "flex";
      } else if (isPre) {
        status.textContent = "PRE-EVENT";
      } else {
        status.textContent = "POST-EVENT";
      }
    </script>

    <script>
      const input = document.getElementById("codeInput");
      if (input) {
        input.addEventListener("input", e => {
          let v = e.target.value.replace(/[^A-Za-z0-9]/g, "").toUpperCase();
          v = v.slice(0, 9);
          if (v.length > 6)
            v = v.slice(0, 3) + "-" + v.slice(3, 6) + "-" + v.slice(6);
          else if (v.length > 3)
            v = v.slice(0, 3) + "-" + v.slice(3);
          e.target.value = v;
        });
      }
    </script>
    <script>
  const statusCells = document.querySelectorAll(
    ".attendance-tile-status"
  );

  statusCells.forEach(cell => {
    const rawStatus = cell.dataset.status;

    if (isPre) {
cell.innerHTML = '<div class="neutral">STANDBY</div>';
  return;
    }

    if (isLive) {
      if (rawStatus === "PENDING") {
     cell.innerHTML = '<div class="negative">PENDING</div>';
      } else {
             cell.innerHTML = '<div class="positive">ATTENDED</div>';

      }
      return;
    }

    // POST EVENT
    if (rawStatus === "PENDING") {
         cell.innerHTML = '<div class="negative">UNATTENDED</div>';
    } else {
         cell.innerHTML = '<div class="positive">ATTENDED</div>';
    }
  });
</script>
  </body>
</html>
