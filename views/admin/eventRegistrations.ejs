<!DOCTYPE html>
<html lang="en">
  <head>
    <%- include('../partials/header.ejs') %>
  </head>
  <body>
    <div class="main">
      <%- include('../partials/navbar.ejs') %> <% const isLive =
      (locals.eventRegistrations.length && locals.now <
      locals.eventRegistrations[0].eventId.endTime && locals.now >=
      locals.eventRegistrations[0].eventId.startTime); const isPost
      =(locals.eventRegistrations.length &&
      locals.now>=locals.eventRegistrations[0].eventId.endTime); const
      isPre=(locals.eventRegistrations.length &&
      locals.now<=locals.eventRegistrations[0].eventId.startTime); const
      attended =locals.eventRegistrations.reduce((acc,
      r)=>(r.attendanceStatus==='ATTENDED')?acc+1:acc,0)
         const formatDateTime = (iso) => { const d = new Date(iso); const time =
    d.toLocaleTimeString("en-US", { hour: "numeric", minute: "2-digit", hour12:
    true, timeZone: "UTC", }); const date = d.toLocaleDateString("en-GB", { day:
    "2-digit", month: "short", year: "numeric", timeZone: "UTC",
    }); return `${time}, ${date}`; }; 
      %>



      <div class="heading-div">
        <h1 class="heading">Attendance Management</h1>
 <% if(isLive) { %>
  <div class="status-live">LIVE üî¥</div>

<% } else if(isPre) { %>
  <div class="status-live">PRE-EVENT</div>

  <% } else { %>
    <div class="status-live">POST-EVENT</div>
    <% } %>
      </div>

          <div class="event-det-container container-border">
        <h1 class="event-det-heading">
          <% if(isLive) { %>
          <div class="event-det-live">üî¥Live</div>
          <% } %>
          <span class="headd"><%= locals.eventDetails.title %></span>
        </h1>
        <p class="event-det-deadline">
          <img
            src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMCIgaGVpZ2h0PSIyMCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IiNmZGZkZmQiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIiBjbGFzcz0ibHVjaWRlIGx1Y2lkZS1hbGFybS1jbG9jay1pY29uIGx1Y2lkZS1hbGFybS1jbG9jayI+PGNpcmNsZSBjeD0iMTIiIGN5PSIxMyIgcj0iOCIvPjxwYXRoIGQ9Ik0xMiA5djRsMiAyIi8+PHBhdGggZD0iTTUgMyAyIDYiLz48cGF0aCBkPSJtMjIgNi0zLTMiLz48cGF0aCBkPSJNNi4zOCAxOC43IDQgMjEiLz48cGF0aCBkPSJNMTcuNjQgMTguNjcgMjAgMjEiLz48L3N2Zz4="
          />
          <span
            >deadline : <%= formatDateTime(locals.eventDetails.deadline)
            %></span
          >
        </p>
        <div class="event-det-body">
          <p class="event-det-dates prim">
            <span class="event-det-start-date"
              >üóìÔ∏è<span
                >&nbsp;<%= formatDateTime(locals.eventDetails.startTime)
                %></span
              ></span
            >
            <span>-></span>
            <span class="event-det-end-date"
              >üóìÔ∏è<span
                >&nbsp;<%= formatDateTime(locals.eventDetails.endTime) %></span
              ></span
            >
          </p>
          <!-- <p class="event-det-venue-details prim">
            <span class="sub-det"
              >Orgainiser:
              <span><%= locals.eventDetails.organiser %></span></span
            >
            <span class="sub-det"
              >üìçVenue: <span><%= locals.eventDetails.venue %></span></span
            >
          </p> -->
          </div></div>




      <% if(isLive) { %>
      <div class="attendance-scanner-div">
        <div class="attendance-scanner-heading">
          üìã Quick Attendance Scanner
        </div>
        <div class="attendance-scanner-sub-heading">
          Enter student's registration code to mark attendance instantly
        </div>
        <form method="post" action="/admin/mark-attendance/<%=locals.eventRegistrations[0].eventId._id%>" class="attendance-scanner-code-div">
          <input required
          name="code"
            type="text"
            id="codeInput"
            placeholder="XXX-XXX-XXX"
            maxlength="11"
            class="attendance-scanner-code"
          />
          <button class="attendance-scanner-code-button">Mark Attendance</b>
        </form>
      </div>

      <% } %>

      <div class="attendance-status-div">
        <div class="attendance-registered-div">
          <div class="attendance-registered-heading">TOTAL REGISTERED</div>
          <div class="attendance-registered">
            <%=locals.eventRegistrations.length%>
          </div>
        </div>
        <div class="attendance-attended-div">
          <div class="attendance-attended-heading">TOTAL ATTENDED</div>
          <div class="attendance-attended"><%=attended%></div>
        </div>
      </div>
      <% if(locals.eventRegistrations.length) { %>
      <div class="attendance-registered-students-list-div">
        <div class="attendance-registered-students-header">
          <div class="attendance-header-name">STUDENT</div>
          <div class="attendance-header-code big">REGISTRATION CODE</div>
          <div class="attendance-header-code small">EVENT CODE</div>
          <div class="attendance-header-status">ATTENDANCE</div>
        </div>

        <% locals.eventRegistrations.forEach(registration=>{ %>
        <div class="attendance-registered-students-tile">
          <div class="attendance-tile-name-email-div">
            <div class="attendance-tile-name">
              <%= registration.userId.fullName %>
            </div>
            <div class="attendance-tile-email">
              <%= registration.userId.email %>
            </div>
          </div>
          <div class="attendance-tile-code">
            <%= registration.registrationCode.match(/.{1,3}/g).join('-'); %>
          </div>
          <div class="attendance-tile-status">
            <% if (isPre) { %>
            <div class="neutral">STANDBY</div>

            <% } else if (isPost) { %> <% if (registration.attendanceStatus ===
            'PENDING') { %>
            <div class="negative">UNATTENDED</div>
            <% } else { %>
            <div class="positive">ATTENDED</div>
            <% } %> <% } else { %> <% if (registration.attendanceStatus ===
            'PENDING') { %>
            <div class="negative">PENDING</div>
            <% } else { %>
            <div class="positive">ATTENDED</div>
            <% } %> <% } %>
          </div>
        </div>

        <% }) %> <% } else {%>

        <div class="message">ü•≤ No registrations yet!</div>
        <% } %>
      </div>
  
    </div>
    <%- include('../partials/footer.ejs') %>
    <script>
      const input = document.getElementById("codeInput");

      input.addEventListener("input", function (e) {
        let value = e.target.value.replace(/[^A-Za-z0-9]/g, "");

        value = value.toUpperCase().substring(0, 9);

        if (value.length > 6) {
          value =
            value.slice(0, 3) + "-" + value.slice(3, 6) + "-" + value.slice(6);
        } else if (value.length > 3) {
          value = value.slice(0, 3) + "-" + value.slice(3);
        }

        e.target.value = value;
      });
    </script>
  </body>
</html>
