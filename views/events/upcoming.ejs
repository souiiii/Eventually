<!DOCTYPE html>
<html lang="en">
  <head>
    <%- include('../partials/header.ejs') %>
  </head>

  <body>
    <div class="main">
      <%- include('../partials/navbar.ejs') %>
      <%  
  //     const toLocalDate = (utcValue) => {
  //   if (!utcValue) return null;
  //   const d = new Date(utcValue); 
  //   return isNaN(d.getTime()) ? null : d;
  // };
      
      
      const
          registeredEventsIds = locals.registeredEvents .filter(m => m.status
          === 'REGISTERED') .map(m => m.eventId.toString()); const
          cancelledEventsIds = locals.registeredEvents .filter(m => m.status ===
          'CANCELLED') .map(m => m.eventId.toString());
          
        //   const pad2 = n => String(n).padStart(2, '0'); const to12Hour = d => { const
        // h24 = d.getHours(); const ap = h24 < 12 ? 'AM' : 'PM'; const h12 = (h24
        // % 12) || 12; return `${h12}:${pad2(d.getMinutes())} ${ap}`; }; const
        // months = [ 'Jan','Feb','Mar','Apr','May','Jun',
        // 'Jul','Aug','Sep','Oct','Nov','Dec' ];
        
        %>
      <div class="heading-div">
        <h1 class="heading">Upcoming Events</h1>
        <form action="/events/discover" method="get" class="sort-by-div">
          <label>
           <span>Sort by:&nbsp;</span>  
              
            <select class="selected" onchange="this.form.submit()" name="sort">
              <option value="nearest_asc" <%= locals.select=== 'nearest' ? 'selected' : '' %> >nearest</option>
              <option value="deadline_asc"  <%= locals.select=== 'deadline' ? 'selected' : '' %> >deadline</option>
              <option value="capacity_desc" <%= locals.select=== 'capacity' ? 'selected' : '' %> >capacity</option>
              <option value="upload-time_desc" <%= locals.select=== 'upload-time' ? 'selected' : '' %> >upload time</option>
            </select>
          </label>
        </form>
      </div>


    
<% if(locals.events.length) { %>
    <div class="event-list-div">
        <% locals.events.forEach(event => { %> <%  
  //       const startDate = toLocalDate(event.startTime);
  // const endDate   = toLocalDate(event.endTime);

  // const startTimeText = to12Hour(startDate);
  // const endTimeText   = to12Hour(endDate);
  // const startDateText = `${pad2(startDate.getDate())} ${months[startDate.getMonth()]}`; %>
<div class="event-div">
<% if(locals.role==='ADMIN') { %>
            <div class="admin-action-form">
            <%if(event.startTime > locals.now) { %>
            <a href="/admin/edit-event/<%= event._id %>" class="admin-edit-button"><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IiAjNTM2MWJkIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIgY2xhc3M9Imx1Y2lkZSBsdWNpZGUtcGVuY2lsLWljb24gbHVjaWRlLXBlbmNpbCI+PHBhdGggZD0iTTIxLjE3NCA2LjgxMmExIDEgMCAwIDAtMy45ODYtMy45ODdMMy44NDIgMTYuMTc0YTIgMiAwIDAgMC0uNS44M2wtMS4zMjEgNC4zNTJhLjUuNSAwIDAgMCAuNjIzLjYyMmw0LjM1My0xLjMyYTIgMiAwIDAgMCAuODMtLjQ5N3oiLz48cGF0aCBkPSJtMTUgNSA0IDQiLz48L3N2Zz4=" /></a>
            
            <form class="admin-delete-form" method="post" action="/admin/delete-event/<%= event._id %>">
              <button type="submit" class="admin-delete-button"><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IiAjNTM2MWJkIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIgY2xhc3M9Imx1Y2lkZSBsdWNpZGUtdHJhc2gtaWNvbiBsdWNpZGUtdHJhc2giPjxwYXRoIGQ9Ik0xOSA2djE0YTIgMiAwIDAgMS0yIDJIN2EyIDIgMCAwIDEtMi0yVjYiLz48cGF0aCBkPSJNMyA2aDE4Ii8+PHBhdGggZD0iTTggNlY0YTIgMiAwIDAgMSAyLTJoNGEyIDIgMCAwIDEgMiAydjIiLz48L3N2Zz4="/></button>
            </form>
            <% } %>
            </div>

          <% } %>
        <a href="/events/<%= event._id %>" class="event-child-div"   data-start="<%= event.startTime.toISOString() %>"
  data-end="<%= event.endTime.toISOString() %>">
          <div class="event-time-div">
            <div class="event-time-internal-div">
       <div class="event-start-time"></div>
<div class="event-start-date"></div>
<div class="event-end-time"></div>
              <img class="dotted-line" src="/images/dotted-line1.webp" />
            </div>
          </div>

          <div class="event-desc-div">
            <div class="event-title"><%= event.title %></div>
            <div class="event-short-description">
              <%= event.shortDescription %>
            </div>
          </div>

          

          <% if (event.startTime <= locals.now && event.endTime >= locals.now) {
          %> <% if (locals.role === 'ADMIN') { %>
          <div class="statusOk">MARK ATTENDANCE-&gt;</div>
          <% } %>

          <div class="live-meter">
            <span>LIVE&nbsp;</span>
            <img
              src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IiM1NEM3OEQiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIiBjbGFzcz0ibHVjaWRlIGx1Y2lkZS1yYWRpby1pY29uIGx1Y2lkZS1yYWRpbyI+PHBhdGggZD0iTTE2LjI0NyA3Ljc2MWE2IDYgMCAwIDEgMCA4LjQ3OCIvPjxwYXRoIGQ9Ik0xOS4wNzUgNC45MzNhMTAgMTAgMCAwIDEgMCAxNC4xMzQiLz48cGF0aCBkPSJNNC45MjUgMTkuMDY3YTEwIDEwIDAgMCAxIDAtMTQuMTM0Ii8+PHBhdGggZD0iTTcuNzUzIDE2LjIzOWE2IDYgMCAwIDEgMC04LjQ3OCIvPjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjIiLz48L3N2Zz4="
            />
          </div>

          <% } %> 
           <% if (locals.role === 'STUDENT') { %>  <% if
          (registeredEventsIds.includes(event._id.toString())) { %>
          <div class="statusOk">REGISTERED</div>
          <% } %> <% if (cancelledEventsIds.includes(event._id.toString())) { %>
          <div class="statusNotOk">CANCELLED</div>
          <% } %> <% } %>
         
        </a>
</div>


        <% }) %>
      </div>
  <% } else { %>
    <div class="message">ðŸ¥² No upcoming events!</div>
    <% } %>

    </div>

    <%- include('../partials/footer.ejs') %>
   <script>
  const pad2 = n => String(n).padStart(2, "0");
  const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];

  const to12Hour = d => {
    const h24 = d.getHours();
    const h12 = h24 % 12 || 12;
    const ap = h24 < 12 ? "AM" : "PM";
    return `${h12}:${pad2(d.getMinutes())} ${ap}`;
  };

  document.querySelectorAll(".event-child-div").forEach(card => {
    const start = new Date(card.dataset.start);
    const end   = new Date(card.dataset.end);

    const startTimeEl = card.querySelector(".event-start-time");
    const startDateEl = card.querySelector(".event-start-date");
    const endTimeEl   = card.querySelector(".event-end-time");

    if (!startTimeEl) return;

    startTimeEl.textContent = to12Hour(start);
    endTimeEl.textContent   = to12Hour(end);
    startDateEl.textContent =
      `${pad2(start.getDate())} ${months[start.getMonth()]}`;
  });
</script>

  </body>
</html>
